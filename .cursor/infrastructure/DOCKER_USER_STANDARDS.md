# Docker User Standards

## üéØ **–ï–¥–∏–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤**

### üìã **–°–¢–ê–ù–î–ê–†–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô**

#### **1. Python Services (–í—Å–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã)**
```dockerfile
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN groupadd -r appuser && useradd -r -g appuser appuser

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤
RUN chown -R appuser:appuser /app

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER appuser
```

#### **2. Database Services (PostgreSQL)**
```dockerfile
# PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è postgres
# –ù–ï —Å–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# PostgreSQL —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
```

#### **3. Web Services (Nginx)**
```dockerfile
# Nginx –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è nginx
# –ù–ï —Å–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# Nginx —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
```

#### **4. Monitoring Services (Prometheus, Grafana, etc.)**
```dockerfile
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# Prometheus: nobody
# Grafana: grafana
# –ù–ï —Å–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

### üîß **–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –°–ï–†–í–ò–°–ê–ú**

#### **Python Services (appuser)**
- ‚úÖ `telegram-bot` - USER appuser
- ‚úÖ `auth-service` - USER appuser  
- ‚úÖ `profile-service` - USER appuser
- ‚úÖ `discovery-service` - USER appuser
- ‚úÖ `media-service` - USER appuser
- ‚úÖ `chat-service` - USER appuser
- ‚úÖ `notification-service` - USER appuser
- ‚úÖ `data-service` - USER appuser
- ‚úÖ `admin-service` - USER appuser (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω)
- ‚úÖ `api-gateway` - USER appuser

#### **Web Services (nginx)**
- ‚ùå `webapp` - –ü–†–û–ë–õ–ï–ú–ê: –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å nginx user
- üîß **–†–ï–®–ï–ù–ò–ï**: –ó–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç root —Å `user root;` –≤ nginx.conf

#### **Database Services (postgres)**
- ‚úÖ `db` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å postgres

#### **Message Queue (rabbitmq)**
- ‚úÖ `rabbitmq` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å rabbitmq

#### **Monitoring Services**
- ‚úÖ `prometheus` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å nobody
- ‚úÖ `grafana` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å grafana
- ‚úÖ `loki` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å nobody
- ‚úÖ `promtail` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å nobody
- ‚úÖ `cadvisor` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å root
- ‚úÖ `node-exporter` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å nobody
- ‚úÖ `postgres-exporter` - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å nobody

### üö® **–ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø**

#### **–ü—Ä–æ–±–ª–µ–º–∞ 1: Webapp Nginx**
```
ERROR: setgid(101) failed (1: Operation not permitted)
```
**–ü—Ä–∏—á–∏–Ω–∞**: Nginx –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å worker –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è nginx (ID 101), –Ω–æ security restrictions –Ω–µ –ø–æ–∑–≤–æ–ª—è—é—Ç.

**–†–µ—à–µ–Ω–∏–µ**: 
```nginx
user root;
worker_processes auto;
```

#### **–ü—Ä–æ–±–ª–µ–º–∞ 2: Security Restrictions**
```
cap_drop: [ALL] + no-new-privileges:true
```
**–ü—Ä–∏—á–∏–Ω–∞**: –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ capabilities:
```yaml
cap_add:
  - CHOWN
  - FOWNER
  - SETGID  # –î–ª—è Nginx
  - SETUID  # –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```

### üìù **–ü–†–ê–í–ò–õ–ê –†–ê–ó–†–ê–ë–û–¢–ö–ò**

#### **1. Python Services**
- –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `appuser`
- –í–°–ï–ì–î–ê –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ `USER appuser`
- –í–°–ï–ì–î–ê —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∞ `chown -R appuser:appuser /app`

#### **2. Web Services (Nginx)**
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `user root;` –≤ nginx.conf
- –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ USER –≤ Dockerfile

#### **3. Database Services**
- –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ USER –≤ Dockerfile

#### **4. Monitoring Services**
- –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ USER –≤ Dockerfile

### üîç **–ü–†–û–í–ï–†–ö–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø**

#### **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker compose exec <service> whoami

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã
docker compose exec <service> ps aux

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
docker compose exec <service> ls -la /app
```

#### **–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- Python services: `appuser`
- Web services: `root` (–¥–ª—è Nginx)
- Database services: `postgres`
- Monitoring services: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

### üìä **–°–¢–ê–¢–£–° –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø**

| Service | Expected User | Current Status | Action Needed |
|---------|---------------|----------------|---------------|
| telegram-bot | appuser | ‚úÖ | - |
| auth-service | appuser | ‚úÖ | - |
| profile-service | appuser | ‚úÖ | - |
| discovery-service | appuser | ‚úÖ | - |
| media-service | appuser | ‚úÖ | - |
| chat-service | appuser | ‚úÖ | - |
| notification-service | appuser | ‚úÖ | - |
| data-service | appuser | ‚úÖ | - |
| admin-service | appuser | ‚úÖ | - |
| api-gateway | appuser | ‚úÖ | - |
| webapp | root | ‚úÖ | Fixed nginx.conf |
| db | postgres | ‚úÖ | - |
| rabbitmq | rabbitmq | ‚úÖ | - |
| prometheus | nobody | ‚úÖ | - |
| grafana | grafana | ‚úÖ | - |
| loki | nobody | ‚úÖ | - |
| promtail | nobody | ‚úÖ | - |
| cadvisor | root | ‚úÖ | - |
| node-exporter | nobody | ‚úÖ | - |
| postgres-exporter | nobody | ‚úÖ | - |

### üéØ **–ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô**

1. ‚úÖ **Python Services** - —É–∂–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É
2. üîß **Webapp** - –∏—Å–ø—Ä–∞–≤–∏—Ç—å nginx.conf (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
3. ‚úÖ **Database Services** - —É–∂–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É  
4. ‚úÖ **Monitoring Services** - —É–∂–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É
5. üìù **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å** - —Å–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
6. üîç **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### üöÄ **–†–ï–ó–£–õ–¨–¢–ê–¢**

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤:
- –í—Å–µ Python —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç `appuser`
- Webapp —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç `root` (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ Nginx)
- Database –∏ Monitoring —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã
